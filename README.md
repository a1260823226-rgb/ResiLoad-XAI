研究问题：
“气象与时间特征如何影响居民负荷？哪些特征在极端天气下最为关键？”

技术栈：
预测模型：LightGBM (基线) + LSTM/Transformer (深度学习)

可解释性：SHAP + 特征重要性 + 局部解释 + 量子机器学习


qistik说明文档：https://qiskit.qotlabs.org/docs/api/qiskit

pennylane说明文档：https://docs.pennylane.ai/en/stable/index.html

SHAP说明文档：https://shap.readthedocs.cn/en/latest/api.html

原始数据来源：https://github.com/yuruotao/District-power

C:\Users\Administrator\.conda\envs\mat\python.exe C:/Users/Administrator/Desktop/chemis/TEST_V6_MULTI_TRANSFORMER.py
================================================================================
V6 多变压器版本 - 使用全部变压器数据进行联合训练
================================================================================
开始时间: 2026-01-20 09:01:20

================================================================================
Step 1-7: 数据加载、特征工程、标准化
================================================================================
正在加载排序后的数据...
  已加载 1,000,000 行...
  已加载 2,000,000 行...
  已加载 3,000,000 行...
  已加载 4,000,000 行...
  已加载 5,000,000 行...
  已加载 6,000,000 行...
✓ 数据加载完成: (6145908, 44)

变压器统计:
  总变压器数: 421
  平均每个变压器样本数: 14598
  最多样本数: 16250
  最少样本数: 47

筛选后（样本数 >= 1000):
  保留变压器数: 419
  总样本数: 6,145,814
✓ 筛选后数据形状: (6145814, 44)

添加时间特征...
添加滞后特征...
添加滚动特征...
添加差分特征...
编码变压器ID...
✓ 特征工程完成: (496444, 85)
✓ 特征矩阵: (496444, 53)
✓ 训练集: 347,510, 验证集: 74,466, 测试集: 74,468
✓ 标准化完成

================================================================================
Step 8: 量子特征编码 (简化版)
================================================================================
初始化PennyLane (n_qubits=4)...
✓ 量子电路初始化完成

处理训练集（347,510 样本）...
训练集量子编码: 100%|██████████| 1159/1159 [00:00<00:00, 1509.49it/s]
验证集量子编码:   0%|          | 0/249 [00:00<?, ?it/s]✓ 训练集量子特征: (347510, 4)

处理验证集（74,466 样本）...
验证集量子编码: 100%|██████████| 249/249 [00:00<00:00, 1564.71it/s]
测试集量子编码:   0%|          | 0/249 [00:00<?, ?it/s]✓ 验证集量子特征: (74466, 4)

处理测试集（74,468 样本）...
测试集量子编码: 100%|██████████| 249/249 [00:00<00:00, 1534.45it/s]
✓ 测试集量子特征: (74468, 4)

✓ 量子特征编码完成

================================================================================
Step 9: 融合特征
================================================================================
✓ 融合完成: 57 特征

================================================================================
Step 10: LightGBM初步训练 (用于特征选择)
================================================================================
训练初步LightGBM模型...
Training until validation scores don't improve for 50 rounds
Early stopping, best iteration is:
[225]	valid_0's l2: 33.8908
✓ 初步模型训练完成

================================================================================
Step 11: 基于特征重要性进行特征选择
================================================================================

Top 20 特征:
               Feature  Importance
                  Hour         667
             LOAD_lag1         555
            LOAD_diff1         445
              Hour_cos         433
           LOAD_diff24         423
            LOAD_lag24         361
              Hour_sin         289
                  TEMP         277
TRANSFORMER_ID_ENCODED         225
   LOAD_rolling_std_24         159
   LOAD_rolling_min_24         157
            LOAD_lag12         136
            LOAD_lag48         122
                   MAX         122
             LOAD_lag6         113
   LOAD_rolling_std_12         112
           LOAD_lag168         102
             LOAD_lag2          99
                  DEWP          95
   LOAD_rolling_min_48          94

✓ 特征选择完成
  原始特征数: 57
  选择特征数: 44 (累积重要性 95%)
  特征数减少: 22.8%

✓ 特征选择后的数据形状:
  训练集: (347510, 44)
  验证集: (74466, 44)
  测试集: (74468, 44)

================================================================================
Step 12: 使用优化参数的LightGBM训练
================================================================================
训练最终LightGBM模型...
参数配置:
  num_leaves: 25
  learning_rate: 0.02
  n_estimators: 800
  max_depth: 6
  min_child_samples: 25
  subsample: 0.75
  colsample_bytree: 0.75
  reg_alpha: 2.0
  reg_lambda: 2.0
  random_state: 42
  verbose: -1
Training until validation scores don't improve for 100 rounds
[20]	training's l2: 1379.32	valid_1's l2: 1070.95	valid_2's l2: 2268.6
[40]	training's l2: 670.7	valid_1's l2: 515.474	valid_2's l2: 1177.55
[60]	training's l2: 345.922	valid_1's l2: 262.059	valid_2's l2: 641.27
[80]	training's l2: 196.025	valid_1's l2: 145.736	valid_2's l2: 386.532
[100]	training's l2: 125.444	valid_1's l2: 91.377	valid_2's l2: 257.939
[120]	training's l2: 91.429	valid_1's l2: 65.656	valid_2's l2: 190.843
[140]	training's l2: 74.3073	valid_1's l2: 53.0163	valid_2's l2: 152.989
[160]	training's l2: 64.9483	valid_1's l2: 46.3367	valid_2's l2: 131.389
[180]	training's l2: 59.5041	valid_1's l2: 42.5958	valid_2's l2: 118.174
[200]	training's l2: 56.1659	valid_1's l2: 40.4401	valid_2's l2: 109.734
[220]	training's l2: 53.9599	valid_1's l2: 39.1138	valid_2's l2: 103.091
[240]	training's l2: 52.3893	valid_1's l2: 38.2859	valid_2's l2: 98.4132
[260]	training's l2: 51.0171	valid_1's l2: 37.4809	valid_2's l2: 94.4423
[280]	training's l2: 49.9188	valid_1's l2: 36.8946	valid_2's l2: 91.5212
[300]	training's l2: 48.9923	valid_1's l2: 36.4263	valid_2's l2: 89.04
[320]	training's l2: 48.3065	valid_1's l2: 36.1215	valid_2's l2: 87.4799
[340]	training's l2: 47.7231	valid_1's l2: 35.8837	valid_2's l2: 86.2849
[360]	training's l2: 47.2221	valid_1's l2: 35.6834	valid_2's l2: 84.9195
[380]	training's l2: 46.7356	valid_1's l2: 35.4252	valid_2's l2: 83.7465
[400]	training's l2: 46.3413	valid_1's l2: 35.2268	valid_2's l2: 83.0528
[420]	training's l2: 45.9807	valid_1's l2: 35.047	valid_2's l2: 82.3891
[440]	training's l2: 45.5706	valid_1's l2: 34.8886	valid_2's l2: 81.873
[460]	training's l2: 45.2165	valid_1's l2: 34.7531	valid_2's l2: 81.4771
[480]	training's l2: 44.8919	valid_1's l2: 34.6022	valid_2's l2: 81.0769
[500]	training's l2: 44.5785	valid_1's l2: 34.468	valid_2's l2: 80.7629
[520]	training's l2: 44.3422	valid_1's l2: 34.3758	valid_2's l2: 80.5204
[540]	training's l2: 44.0757	valid_1's l2: 34.2744	valid_2's l2: 80.3992
[560]	training's l2: 43.8065	valid_1's l2: 34.1616	valid_2's l2: 80.1413
[580]	training's l2: 43.574	valid_1's l2: 34.0832	valid_2's l2: 80.025
[600]	training's l2: 43.3363	valid_1's l2: 34.0122	valid_2's l2: 79.8959
[620]	training's l2: 43.1247	valid_1's l2: 33.9853	valid_2's l2: 79.6019
[640]	training's l2: 42.919	valid_1's l2: 33.9513	valid_2's l2: 79.4359
[660]	training's l2: 42.7315	valid_1's l2: 33.9968	valid_2's l2: 79.563
[680]	training's l2: 42.5462	valid_1's l2: 33.9688	valid_2's l2: 79.5861
[700]	training's l2: 42.3764	valid_1's l2: 33.9669	valid_2's l2: 79.6591
[720]	training's l2: 42.2138	valid_1's l2: 33.9061	valid_2's l2: 79.6906
[740]	training's l2: 42.0582	valid_1's l2: 33.9226	valid_2's l2: 79.5634
Early stopping, best iteration is:
[652]	training's l2: 42.8044	valid_1's l2: 33.9478	valid_2's l2: 79.3646

✓ LightGBM训练完成（耗时: 6.63秒）
  最佳迭代: 652

================================================================================
Step 13: 预测和评估
================================================================================
✓ 预测完成

训练集 指标:
  R² Score: 0.985443
  RMSE: 6.5425
  MAE: 4.3410
  MAPE: 9582820415958836.0000%

验证集 指标:
  R² Score: 0.983698
  RMSE: 5.8265
  MAE: 3.8604
  MAPE: 13198127641938922.0000%

测试集 指标:
  R² Score: 0.982348
  RMSE: 8.9087
  MAE: 4.4166
  MAPE: 19333953448770704.0000%

过拟合检查:
  训练-测试R²差异: 0.003095
  状态: ✓ 良好

================================================================================
Step 14: K-Fold 交叉验证
================================================================================
执行 5-Fold 交叉验证...
Training until validation scores don't improve for 50 rounds
Did not meet early stopping. Best iteration is:
[800]	training's l2: 41.1966	valid_1's l2: 45.4492
  Fold 1: R² = 0.984511, RMSE = 6.7416
Training until validation scores don't improve for 50 rounds
Did not meet early stopping. Best iteration is:
[800]	training's l2: 41.0928	valid_1's l2: 46.2564
  Fold 2: R² = 0.984447, RMSE = 6.8012
Training until validation scores don't improve for 50 rounds
Did not meet early stopping. Best iteration is:
[800]	training's l2: 41.6179	valid_1's l2: 43.0692
  Fold 3: R² = 0.985192, RMSE = 6.5627
Training until validation scores don't improve for 50 rounds
Did not meet early stopping. Best iteration is:
[800]	training's l2: 41.1674	valid_1's l2: 45.1342
  Fold 4: R² = 0.984716, RMSE = 6.7182
Training until validation scores don't improve for 50 rounds
Did not meet early stopping. Best iteration is:
[800]	training's l2: 41.3239	valid_1's l2: 43.9615
  Fold 5: R² = 0.985008, RMSE = 6.6303

交叉验证结果:
  平均 R²: 0.984775 ± 0.000320
  平均 RMSE: 6.6908 ± 0.0943

================================================================================
Step 15: SHAP可解释性分析
================================================================================
SHAP版本: 0.49.1
✓ SHAP TreeExplainer初始化完成
  分析样本数: 1000

计算SHAP值（1000 个测试样本）...
✓ SHAP值计算完成

Top 20 特征（SHAP重要性排名）
================================================================================
  SLP                                     :  35.709456 [经典]
  LOAD_rolling_std_168                    :  10.740077 [经典]
  LOAD_lag3                               :   1.636881 [经典]
  PRCP                                    :   1.202220 [经典]
  LOAD_lag48                              :   0.924581 [经典]
  Quantum_1                               :   0.810818 [量子]
  LOAD_lag168                             :   0.530665 [经典]
  LOAD_rolling_std_12                     :   0.505471 [经典]
  LOAD_lag72                              :   0.439098 [经典]
  Hour                                    :   0.392390 [经典]
  LOAD_rolling_max_48                     :   0.218564 [经典]
  LOAD_rolling_min_6                      :   0.217633 [经典]
  STP                                     :   0.216337 [经典]
  LOAD_rolling_max_12                     :   0.213819 [经典]
  Quantum_3                               :   0.196033 [量子]
  Month_sin                               :   0.157671 [经典]
  HEAT_INDEX_EXTREME_CAUTION              :   0.153516 [经典]
  Hour_cos                                :   0.148535 [经典]
  RH                                      :   0.142559 [经典]
  MAX                                     :   0.138314 [经典]

生成SHAP可视化...
✓ SHAP摘要图已保存
✓ SHAP条形图已保存
生成SHAP力图...
✓ SHAP力图已保存（前5个样本）
生成SHAP依赖图...
✓ SHAP依赖图已保存

✓ SHAP分析完成

================================================================================
Step 16: 保存模型和结果
================================================================================
✓ 模型已保存
✓ 标准化器已保存
✓ 特征列表已保存
✓ 变压器ID编码器已保存
✓ 测试集预测结果已保存
✓ 评估指标已保存
✓ 交叉验证结果已保存
✓ 特征重要性已保存
✓ SHAP重要性已保存
✓ SHAP详细分析已保存
✓ 特征重要性对比已保存

✓ 所有结果已保存到: model_output_v6_multi/

================================================================================
Step 17: 可视化分析
================================================================================
✓ 综合分析图已保存
生成时间序列预测图...
✓ 时间序列预测图已保存
生成特征重要性对比图...
✓ 特征重要性对比图已保存

✓ 可视化完成

================================================================================
Step 18: 生成最终报告
================================================================================

================================================================================
V6 多变压器版本 - 使用全部变压器数据进行联合训练
================================================================================

执行时间: 2026-01-20 09:02:49

================================================================================
数据统计
================================================================================

原始数据:
  总行数: 496,444
  变压器数: 419
  平均每个变压器样本数: 1,184

特征统计:
  原始特征数: 57
  选择特征数: 44
  特征减少比例: 22.8%

数据集划分:
  训练集: 347,510 样本
  验证集: 74,466 样本
  测试集: 74,468 样本

================================================================================
模型性能
================================================================================

训练集:
  R² Score: 0.985443
  RMSE: 6.5425
  MAE: 4.3410
  MAPE: 9582820415958836.0000%

验证集:
  R² Score: 0.983698
  RMSE: 5.8265
  MAE: 3.8604
  MAPE: 13198127641938922.0000%

测试集:
  R² Score: 0.982348
  RMSE: 8.9087
  MAE: 4.4166
  MAPE: 19333953448770704.0000%

过拟合检查:
  训练-测试R²差异: 0.003095
  状态: ✓ 良好

================================================================================
5-Fold 交叉验证结果
================================================================================

平均 R²: 0.984775 ± 0.000320
平均 RMSE: 6.6908 ± 0.0943

各 Fold 结果:
  Fold 1: R² = 0.984511, RMSE = 6.7416
  Fold 2: R² = 0.984447, RMSE = 6.8012
  Fold 3: R² = 0.985192, RMSE = 6.5627
  Fold 4: R² = 0.984716, RMSE = 6.7182
  Fold 5: R² = 0.985008, RMSE = 6.6303

================================================================================
LightGBM 特征重要性分析
================================================================================

Top 20 特征:
  13. Hour                                    : 667.000000 [经典]
  23. LOAD_lag1                               : 555.000000 [经典]
  52. LOAD_diff1                              : 445.000000 [经典]
  17. Hour_cos                                : 433.000000 [经典]
  53. LOAD_diff24                             : 423.000000 [经典]
  28. LOAD_lag24                              : 361.000000 [经典]
  16. Hour_sin                                : 289.000000 [经典]
   1. TEMP                                    : 277.000000 [经典]
  22. TRANSFORMER_ID_ENCODED                  : 225.000000 [经典]
  39. LOAD_rolling_std_24                     : 159.000000 [经典]
  44. LOAD_rolling_min_24                     : 157.000000 [经典]
  27. LOAD_lag12                              : 136.000000 [经典]
  29. LOAD_lag48                              : 122.000000 [经典]
   3. MAX                                     : 122.000000 [经典]
  26. LOAD_lag6                               : 113.000000 [经典]
  38. LOAD_rolling_std_12                     : 112.000000 [经典]
  31. LOAD_lag168                             : 102.000000 [经典]
  24. LOAD_lag2                               :  99.000000 [经典]
   4. DEWP                                    :  95.000000 [经典]
  45. LOAD_rolling_min_48                     :  94.000000 [经典]

================================================================================
SHAP 特征重要性分析
================================================================================

Top 20 特征（SHAP重要性排名）:
   2. SLP                                     :  35.709456 [经典]
   6. LOAD_rolling_std_168                    :  10.740077 [经典]
  13. LOAD_lag3                               :   1.636881 [经典]
  25. PRCP                                    :   1.202220 [经典]
   1. LOAD_lag48                              :   0.924581 [经典]
  11. Quantum_1                               :   0.810818 [量子]
   4. LOAD_lag168                             :   0.530665 [经典]
   7. LOAD_rolling_std_12                     :   0.505471 [经典]
  18. LOAD_lag72                              :   0.439098 [经典]
   8. Hour                                    :   0.392390 [经典]
  21. LOAD_rolling_max_48                     :   0.218564 [经典]
  16. LOAD_rolling_min_6                      :   0.217633 [经典]
  17. STP                                     :   0.216337 [经典]
   3. LOAD_rolling_max_12                     :   0.213819 [经典]
  20. Quantum_3                               :   0.196033 [量子]
  32. Month_sin                               :   0.157671 [经典]
   5. HEAT_INDEX_EXTREME_CAUTION              :   0.153516 [经典]
  19. Hour_cos                                :   0.148535 [经典]
  10. RH                                      :   0.142559 [经典]
  30. MAX                                     :   0.138314 [经典]

SHAP 统计信息:
  平均SHAP值范围: [-35.709456, 0.115721]
  SHAP标准差范围: [0.008892, 4.540466]

特征类型分布:
  量子特征: 2 个
  经典特征: 42 个

================================================================================
版本对比
================================================================================

V6 单变压器版本:
  - 变压器数: 1
  - 样本数: ~8,760
  - 测试集 R²: 0.82+

V6 多变压器版本 (当前):
  - 变压器数: 419
  - 样本数: 496,444
  - 测试集 R²: 0.982348
  - 改进: ✓ 显著改进

================================================================================
关键改进
================================================================================

1. ✓ 使用全部变压器数据
   - 从 1 个变压器 → 419 个变压器
   - 样本数增加 56.0x

2. ✓ 添加变压器ID特征
   - 模型可以学习不同变压器的特性差异
   - 提高泛化能力

3. ✓ 按变压器分组计算滞后和滚动特征
   - 避免不同变压器之间的数据泄漏
   - 保证特征的有效性

4. ✓ 特征选择
   - 保留累积重要性 95% 的特征
   - 减少过拟合风险

5. ✓ 完整的SHAP可解释性分析
   - SHAP重要性排名
   - SHAP摘要图、条形图、力图、依赖图
   - 特征重要性对比分析

================================================================================
输出文件
================================================================================

模型文件:
  ✓ model.pkl - 训练好的LightGBM模型
  ✓ scaler.pkl - RobustScaler标准化器
  ✓ selected_features.pkl - 选择的特征列表
  ✓ label_encoder.pkl - 变压器ID编码器

结果文件:
  ✓ test_predictions.csv - 测试集预测结果
  ✓ metrics.csv - 评估指标
  ✓ cv_results.csv - 交叉验证结果
  ✓ feature_importance.csv - LightGBM特征重要性
  ✓ shap_importance.csv - SHAP特征重要性
  ✓ shap_detailed_analysis.csv - SHAP详细分析
  ✓ feature_importance_comparison.csv - 特征重要性对比

可视化文件:
  ✓ comprehensive_analysis.png - 综合分析图
  ✓ timeseries_prediction.png - 时间序列预测图
  ✓ feature_importance_comparison.png - 特征重要性对比图
  ✓ shap_summary_plot.png - SHAP摘要图
  ✓ shap_bar_plot.png - SHAP条形图
  ✓ shap_force_plot_*.png - SHAP力图（前5个样本）
  ✓ shap_dependence_plots.png - SHAP依赖图

缓存文件:
  ✓ quantum_cache_v6_multi/ - 量子特征缓存目录

输出目录: model_output_v6_multi/

================================================================================
完成时间: 2026-01-20 09:02:49
================================================================================


✓ 最终报告已保存到: model_output_v6_multi/optimization_report.txt

================================================================================
V6 多变压器版本完成！
================================================================================

进程已结束,退出代码0

================================================================================

进程已结束,退出代码0
